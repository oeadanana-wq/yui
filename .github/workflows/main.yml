name: RDP (Windows)

on:
  workflow_dispatch:

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        run: |
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Set password for runner user
        run: |
          $password = "Amirul10021996@#$!"
          net user runneradmin $password
          echo "RDP_USER=runneradmin" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          iwr https://tailscale.com/install.ps1 -useb | iex
          tailscale up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=gh-win-${{ github.run_id }}

      - name: Wait for Tailscale IP
        run: |
          $ip=""
          for ($i=0; $i -lt 12; $i++) {
            $ip = (tailscale ip -4)
            if ($ip) { break }
            Start-Sleep -Seconds 5
          }

          if ($ip) {
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          } else {
            echo "TAILSCALE_IP=NOT_FOUND" >> $env:GITHUB_ENV
          }

      - name: Show RDP info & keep alive
        run: |
          echo "=============================="
          echo " WINDOWS RDP READY"
          echo " Address : $env:TAILSCALE_IP"
          echo " User    : $env:RDP_USER"
          echo " Pass    : $env:RDP_PASS"
          echo "=============================="
          echo "Cancel workflow to stop RDP"

          while ($true) {
            Write-Host "$(Get-Date) RDP Active"
            Start-Sleep -Seconds 300
          }
