name: RDP (Windows)

on:
  workflow_dispatch:

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        shell: powershell
        run: |
          Write-Host "Enabling RDP..."
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" `
            /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Set password for runner user
        shell: powershell
        run: |
          $password = "Amirul10021996@#$!"
          net user runneradmin $password

          echo "RDP_USER=runneradmin" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale (MSI - Stable)
        shell: powershell
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "Downloading Tailscale MSI..."
          $msi = "$env:TEMP\tailscale.msi"

          Invoke-WebRequest `
            -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" `
            -OutFile $msi

          Write-Host "Installing Tailscale..."
          Start-Process msiexec.exe -Wait `
            -ArgumentList "/i `"$msi`" /quiet /norestart"

          Write-Host "Starting Tailscale..."
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey=$env:TAILSCALE_AUTH_KEY `
            --hostname=gh-win-${{ github.run_id }}

      - name: Wait for Tailscale IP
        shell: powershell
        run: |
          Write-Host "Waiting for Tailscale IP..."
          $ip = ""

          for ($i = 0; $i -lt 12; $i++) {
            try {
              $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            } catch {}
            if ($ip) { break }
            Start-Sleep -Seconds 5
          }

          if ($ip) {
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          } else {
            echo "TAILSCALE_IP=NOT_FOUND" >> $env:GITHUB_ENV
          }

      - name: Show RDP info & keep alive
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "===================================="
          Write-Host "   WINDOWS RDP VIA TAILSCALE READY"
          Write-Host "------------------------------------"
          Write-Host " Address : $env:TAILSCALE_IP"
          Write-Host " User    : $env:RDP_USER"
          Write-Host " Pass    : $env:RDP_PASS"
          Write-Host "------------------------------------"
          Write-Host " Stop RDP: Actions -> Cancel workflow"
          Write-Host "===================================="
          Write-Host ""

          while ($true) {
            Write-Host "$(Get-Date) RDP ACTIVE"
            Start-Sleep -Seconds 300
          }
